
\documentclass{article}
\title{Supplementary Material for Variance in Variants: Propagating Genome Sequence Uncertainty into Phylogenetic Lineage Assignment}
\author{David Champredon, Devan Becker, Connor Chato, Gopi Gugan, Art Poon}
\date{}

\input{latex-pckg.tex}
\input{latex-macro.tex}

\begin{document}
\maketitle

\section{Deletions and Insertions}


By construction, the \nlps must be defined with its longest possible length.
Deletions are naturally modelled with our representation but insertions have to be modelled using deletion probabilities. 
\begin{equation}
\label{eq:indel}
\nps = 
\bordermatrix{
&\scriptscriptstyle{1} & \scriptscriptstyle{2}& \scriptscriptstyle{3}& \scriptscriptstyle{4} & \scriptscriptstyle{5} & \scriptscriptstyle{6} \cr
\sq{A} & 0 & 0   & 1 & 0    & 1 & 0\cr
\sq{C} & 1 & 0    & 0 & 0    & 0 & 0\cr
\sq{G} & 0 & 0.99 & 0 & 0    & 0 & 0\cr
\sq{T} & 0 & 0    & 0 & 0.01 & 0 & 1\cr
\sq{-} & 0 & 0.01 & 0 & 0.99 & 0 & 0\cr
}
\end{equation}

The low deletion probability for position 2 is straightforward to interpret: in about 1\% of the reads that contained this position, nucleotide \sq{G} at position 2 is deleted.
The high deletion probability for position 4 means there is a 1\% chance of a \sq{T} insertion at this position (\autoref{tab:spsexample}).

\begin{table}[H]
\begin{center}
\begin{tabular}{ll}
\hline
\textbf{sequence} & \textbf{probability} \\
\hline
$\sps_1$ = \sq{CGAAT}  & $a(1) = 0.9799$ \\
$\sps_2$ = \sq{CAAT}   & $a(2) = 0.01$  \\
$\sps_3$ = \sq{CGATAT} & $a(3) = 0.01$ \\
$\sps_4$ = \sq{CATAT}  & $a(4) = 0.0001$  \\
\hline
\end{tabular}
\end{center}
\caption{Sequence-level probabilistic sequence defined by Equation \eqref{eq:indel}}
\label{tab:spsexample}
\end{table}


Insertions (`I` operations) are non-trivial to include in the probabilistic sequence.
Consider a short read with two bases inserted at position $j$ (say, an \sq{A} at position $j+1$ and a \sq{T} at position $j+2$) and a short read with one insertion at position $j$ (say, a \sq{C}).
It is entirely ambiguous whether the single insertion (\sq{C}) aligns with the first insertion (\sq{A}) or the second insertion (\sq{T}) of the first short read. 
This is problematic for building up the matrix from reads aligned to the reference sequence.
It is conceptually and computationally simpler to start from a populated matrix and sampling insertions.
For our purposes, we only consider the alignment of these sequences with a reference sequence and thus do not consider insertions.

\section{Paired-End Reads}

Some NGS platforms (\eg Illumina) use paired-end reads where the same nucleic acid template is read in both directions.
In these situations, we simply adjust all values by a factor of one half.
For bases where the paired-end reads overlap, this has the effect of averaging the base probability $1-\epsilon$.
For example, if $1-\epsilon$ is 90\% for $\sq{A}$ in one read and 95\% $\sq{A}$ in its mate, then 0.925 is added to the $\sq{A}$ row in $\nps'$ (with the remaining 0.075 uniformly distributed across the other nucleotides).
If the two reads were 60\% $\sq{A}$ and 55\% $\sq{C}$ at the same position, then we would increment the corresponding column vector ($\sq{A}, \sq{T}, \sq{C}, \sq{G}$) by $(0.6/2, 0.1/2, 0.1/2, 0.1/2)$ for the first read and $(0.15/2, 0.15/2, 0.55/2, 0.15/2)$ for the second, resulting in an addition of $(0.375, 0.125, 0.325, 0.125)$ for this pair.
Bases outside of the overlapping region contribute a maximum of 0.5 to $\nps'$, because the base call on the other read is missing data.
This approach has the advantage of making the parsing of SAM files trivially parallelizable since we do not need to know how reads are paired.
In addition, the coverage calculated from $\nps'$ is scaled to the number of templates rather than the number of reads.



\section{Sequence-level uncertainty}

A significant problem of storing probabilities at the level of individual nucleotides is that generating a sequence from this matrix requires drawing $\ell$ independent outcomes.
For example, the reference SARS-CoV-2 genome is 29,903 nucleotides, and a substantial number of naturally-occurring sequence insertions have been described.
Thus it would not be surprising if $\ell$ exceeded 30,000 nucleotides (nt).
The majority of these technically possible $5^\ell$ sequences are not biologically plausible.
Therefore, we formulate an ordered subset $\sps = (\sps_i)_{i\in\{1\ldots m\} }$ of the first $m$ most likely sequences, which are ranked in descending order by the joint probability of nucleotide composition.
Note that the sequences in $\sps$, $\sps_i$, do not necessarily have the same length.
The observed genetic sequence, $s^*$, is a sample from a specified discrete probability distribution $a$:
\begin{equation}
\pr{s^* = \sps_i | i ... m} = a(i)
\end{equation}
This compact and approximate representation drastically reduces the number of operations to one sample, after some pre-processing to calculate $a$.
The observed plurality sequence $s^*$ (the sequence consisting of the most likely base at each position) is guaranteed to be a member of $\sps$ if $\nps_{s(j), j} > 0.5\;\forall\;j$ where $s(j)$ is the $j$-th nucleotide of $s^*$; indeed, it is guaranteed to be the highest ranked member $i=0$.
We refer to any member of the set $\sps$ as a \emph{\slps}.
Note that because $a$ is a probability distribution, we must have $\sum_{i=1}^m a(i) = 1$.
In other words, this probability is conditional on the sequence being in $\sps$.


For example, suppose that we have the following \nlps:
\begin{equation}
\nps = 
\bordermatrix{
& \scriptscriptstyle{1} & \scriptscriptstyle{2}& \scriptscriptstyle{3}& \scriptscriptstyle{4} & \scriptscriptstyle{5} & \scriptscriptstyle{6} \cr
\sq{A} & 0.9 & 0.05   & 0.99 & 0 & 0 & 0.6\cr
\sq{C} & 0   & 0.8 & 0 & 0 & 0.1 & 0.1\cr
\sq{G} & 0.1 & 0.15 & 0 & 0.3 & 0.9 & 0\cr
\sq{T} & 0 & 0 & 0.01 & 0.7 & 0 & 0.3\cr
\sq{-} & 0 & 0 & 0 & 0 & 0 & 0\cr
}\label{eq:nlps}
\end{equation}
such that there are $2\times 3 \times 2^3 \times 3 = 144$ possible sequences.
The most likely sequence has the highest joint nucleotide probability: \sq{ACATGA} with probability 0.2694 ($0.9\times 0.8\times 0.99 \times 0.7 \times 0.9 \times 0.6$).
If there is a positive probability of deletion for at least one position, then the sequence has a variable length.
Large genomes or sequencing targets will result in vanishingly small probabilities for all sequences, and thus calculations on the log scale may be necessary to reduce the chance of numerical underflow.


Table \ref{tab:biopossible} demonstrates the calculation of sequence-level uncertainties using the values in \eqref{eq:nlps}.
The probability column is the product of the matrix entries for each nucleotide.
If the four sequences shown are the only biologically plausible sequences, then the normalized probabilities can be expressed as $a(i)$.

\begin{table}[H]
\begin{center}
\begin{tabular}{lll}
\hline
\textbf{sequence} & \textbf{probability} & $a(i)$\\
\hline
$\sps_1$ = \sq{ACATGA}  &  0.299 & $a(1) = 0.467$ \\
$\sps_2$ = \sq{ACATGT}  &  0.150 & $a(2) = 0.233$  \\
$\sps_3$ = \sq{ACAGGA}  &  0.128 & $a(3) = 0.200$ \\
$\sps_4$ = \sq{ACAGGT}  &  0.064 & $a(4) = 0.100$  \\
\hline
\end{tabular}
\end{center}
\caption{Biologically plausible sequences with probabilities defined by Equation \eqref{eq:nlps}}
\label{tab:biopossible}
\end{table}



\section{Consensus Sequence FASTQ and FASTA Files}
\label{fastq_construction}

Full length or partial genome sequences are now frequently the product of next-generation sequencing, by taking the consensus of the aligned or assembled read data.
However, the original read data are often not published alongside the consensus sequence.
Some consensus sequences are released in a format where the bases are annotated with quality scores, \eg FASTQ.
There are several programs that provide methods to convert a SAM file into a consensus FASTQ file \citep{liAdjustQualityScores2004, keithSimulatedAnnealingAlgorithm2002, liMappingShortDNA2008a}.
These programs use slightly different methods for generating consensus quality scores, but filter quality scores for the majority base.
For example, suppose there are three reads with the following base calls at position $j$: \sq{A} with $Q=30$, \sq{A} with $Q=31$, and \sq{C} with $Q=15$.
Calculation of the consensus quality score will thereby exclude the $Q=15$ value and report a quality score calculated from $Q=30$ and $Q=31$, with the details of the calculation differing by software.


This omission makes it challenging for us to generate an $\nps$ matrix from a consensus FASTQ file.
Given the consensus base and its associated quality score at position $j$, we must assume that the other bases are all equally likely with probability $\epsilon_j/3$ (similar to \cite{kuoEAGLEExplicitAlternative2018} and Chapter 5 of \citet{kozlovModelsOptimizationsTools2018}).
For example, let's assume the output sequence after fragment sequencing and alignment is \sq{ACATG} and its associated quality scores are respectively $Q=(60,30,50,10,40)$.
The probabilistic sequence is:
\begin{equation}
\nps = 
\bordermatrix{
&\scriptscriptstyle{1} & \scriptscriptstyle{2}& \scriptscriptstyle{3}& \scriptscriptstyle{4} & \scriptscriptstyle{5} \cr
\sq{A} & 1-10^{-6} & 10^{-3}/3  & 1-10^{-5} & 10^{-1}/3 & 10^{-4}/3  \cr
\sq{C} & 10^{-6}/3 & 1-10^{-3}  & 10^{-5}/3 & 10^{-1}/3 & 10^{-4}/3  \cr
\sq{G} & 10^{-6}/3 & 10^{-3}/3  & 10^{-5}/3 & 10^{-1}/3 & 1-10^{-4} \cr
\sq{T} & 10^{-6}/3 & 10^{-3}/3  & 10^{-5}/3 & 1-10^{-1} & 10^{-4}/3 \cr
\sq{-} & 0 & 0 & 0 & 0 & 0 \cr
}
\end{equation}
Usually, the genetic sequence \sq{ACATG} would be considered as certain and quality scores discarded.
In contrast, the probability of the sequence \sq{ACATG} is only 0.899 within the probabilistic sequence framework.


Incorporating deletions in the absence of raw data is also challenging.
If one is willing to assume a global deletion rate, then it is possible to extend the parameterization of $\nps$.
For example, if the probability of a single nucleotide deletion is $d$, then the probability of the called base is $(1-d_j)(1-\epsilon_j)$ and the other three nucleotides have probability $(1-d)\epsilon_j/3$.
Hence, if we assume the base call is \sq{A}, the column of the \nlps for that position is
\begin{equation}
\nps(,j) = 
\bordermatrix{
&\scriptscriptstyle{j}  \cr
\sq{A} & (1 - d)(1-\epsilon_j) \cr
\sq{C} & (1 - d)\epsilon_j/3 \cr
\sq{G} & (1 - d)\epsilon_j/3 \cr
\sq{T} & (1 - d)\epsilon_j/3 \cr
\sq{-} & d \cr
}
\label{eq:deletion}
\end{equation}

Since the FASTQ file only has a single sequence, we do have the same issues with alignment of differing lengths of insertions.
In fact, insertions are only insertions relative to the reference sequence; they can simply be treated as observed nucleotides with an associated quality score.
It would be possible to give insertions special treatment, however, by defining a global insertion rate.
This insertion rate can be expressed as a deletion rate relative to the observed sequence, and thus one minus the insertion rate can be treated as the deletion rate in the probabilistic sequence.
As with the deletion rate, this requires an assumption about a global rate which may be arbitrary.


A primary use of the probability sequence created from these FASTQ files would be to construct a probability sequence as a reference genome for a given category.
This would entail collecting all available FASTQ files for a given lineage designation and using them in the construction of a probability sequence as if they were short reads in a SAM file.
From here, lineage designation for a newly acquired sequence (and its probability sequence) could be performed via a hypothesis test for whether the probability sequences are sufficiently similar. 

\subsubsection{Consensus sequence FASTA files}


If we do not have access to any base quality information, \eg the consensus sequence is published as a FASTA file, then our ability to populate $\nps$ is severely limited.
Any uncertainty that we impose upon the data will be a principled assumption.
The error probability at the $j$ position of the consensus sequence can be simulated as a beta distribution, \ie \vspace{-4mm}

$$
\epsilon_j \sim\text{Beta}(\alpha, \beta)
$$

The called base at position $j$ has probability $1-\epsilon_j$, and the remaining bases are assigned $\epsilon_j/3$.
To incorporate deletions, another probability $d$ can be generated as the \emph{gap probability}.
With these defined, the nucleotide-level probabilistic sequence at the $j$th column (assuming the base call at position $j$ was $\sq{A}$) can be written as above.
This probabilistic sequence is completely fabricated, \ie not based on any empirical data.
However, the sensitivity of an analysis can be evaluated by choosing different values of $\alpha$, $\beta$, and $d$ (\eg based on previous studies) and propagating these uncertainties into downstream analyses.
The results from such an analysis would not indicate anything about the sequence itself but could be used to determine how robust the methods are to increased sequence uncertainty.




\section{Accession Numbers}

The following table lists all of the NCBI SRA accession numbers used in this paper.

% latex table generated in R 4.0.4 by xtable 1.8-4 package
% Tue Nov 16 10:42:23 2021
\begin{table}[ht]
\centering
\small
\begin{tabular}{llllll}
ERR4085809 & ERR4890354 & ERR4892048 & ERR5064166 & ERR5082590 & SRR13021020 \\ 
  ERR4204823 & ERR4890371 & ERR4892066 & ERR5064294 & ERR5082598 & SRR13021022 \\ 
  ERR4305816 & ERR4890386 & ERR4892112 & ERR5064346 & ERR5082599 & SRR13021027 \\ 
  ERR4307842 & ERR4890403 & ERR4892152 & ERR5064787 & ERR5082600 & SRR13021032 \\ 
  ERR4440194 & ERR4890427 & ERR4892200 & ERR5064811 & ERR5082606 & SRR13021033 \\ 
  ERR4440219 & ERR4890531 & ERR4892203 & ERR5074314 & ERR5082610 & SRR13021035 \\ 
  ERR4440247 & ERR4890572 & ERR4892293 & ERR5076163 & ERR5082622 & SRR13021038 \\ 
  ERR4440332 & ERR4890609 & ERR4892339 & ERR5076748 & ERR5082630 & SRR13021042 \\ 
  ERR4440354 & ERR4890693 & ERR4892386 & ERR5077151 & ERR5082645 & SRR13021047 \\ 
  ERR4440373 & ERR4890746 & ERR4892392 & ERR5077411 & ERR5082654 & SRR13021052 \\ 
  ERR4440402 & ERR4890771 & ERR4892423 & ERR5077618 & ERR5082656 & SRR13021053 \\ 
  ERR4440425 & ERR4890819 & ERR4893013 & ERR5077713 & ERR5082673 & SRR13021059 \\ 
  ERR4440731 & ERR4890820 & ERR4893031 & ERR5077924 & ERR5082674 & SRR13021061 \\ 
  ERR4692420 & ERR4890881 & ERR4893033 & ERR5078210 & ERR5082694 & SRR13021067 \\ 
  ERR4692568 & ERR4890926 & ERR4893037 & ERR5078863 & ERR5082695 & SRR13021072 \\ 
  ERR4692877 & ERR4890974 & ERR4893080 & ERR5078897 & ERR5082696 & SRR13021073 \\ 
  ERR4692945 & ERR4891001 & ERR4893138 & ERR5079000 & ERR5082700 & SRR13021077 \\ 
  ERR4693014 & ERR4891011 & ERR4893184 & ERR5079423 & ERR5082702 & SRR13021084 \\ 
  ERR4693019 & ERR4891037 & ERR4893186 & ERR5079699 & ERR5082706 & SRR13021090 \\ 
  ERR4693495 & ERR4891061 & ERR4893197 & ERR5080131 & ERR5082708 & SRR13021093 \\ 
  ERR4693801 & ERR4891103 & ERR4893242 & ERR5080159 & ERR5082710 & SRR13021097 \\ 
  ERR4693865 & ERR4891178 & ERR4893353 & ERR5080327 & ERR5082711 & SRR13021098 \\ 
  ERR4694010 & ERR4891235 & ERR4893393 & ERR5080504 & ERR5082712 & SRR13021099 \\ 
  ERR4694330 & ERR4891238 & ERR4999251 & ERR5080893 & SRR11433882 & SRR13021104 \\ 
  ERR4694380 & ERR4891261 & ERR4999255 & ERR5080897 & SRR11433888 & SRR13021107 \\ 
  ERR4694400 & ERR4891304 & ERR4999275 & ERR5080913 & SRR11433893 & SRR13021109 \\ 
  ERR4694498 & ERR4891415 & ERR4999282 & ERR5080918 & SRR12639958 & SRR13021111 \\ 
  ERR4694556 & ERR4891433 & ERR5060778 & ERR5081077 & SRR12639961 & SRR13021113 \\ 
  ERR4694571 & ERR4891444 & ERR5062004 & ERR5081293 & SRR12749715 & SRR13021115 \\ 
  ERR4694617 & ERR4891493 & ERR5062062 & ERR5081301 & SRR12749716 & SRR13021124 \\ 
  ERR4759453 & ERR4891497 & ERR5062388 & ERR5081304 & SRR12762573 & SRR13021130 \\ 
  ERR4869446 & ERR4891532 & ERR5062514 & ERR5081316 & SRR13020989 & SRR13021131 \\ 
  ERR4869458 & ERR4891572 & ERR5062571 & ERR5081322 & SRR13020990 & SRR13021133 \\ 
  ERR4869480 & ERR4891675 & ERR5062648 & ERR5081836 & SRR13020991 & SRR13021134 \\ 
  ERR4869487 & ERR4891711 & ERR5062729 & ERR5082214 & SRR13020998 & SRR13021135 \\ 
  ERR4869497 & ERR4891715 & ERR5062935 & ERR5082346 & SRR13020999 & SRR13021143 \\ 
  ERR4890228 & ERR4891805 & ERR5063143 & ERR5082556 & SRR13021003 & SRR13092002 \\ 
  ERR4890271 & ERR4891841 & ERR5063165 & ERR5082561 & SRR13021008 & SRR13592146 \\ 
  ERR4890285 & ERR4891863 & ERR5063539 & ERR5082569 & SRR13021010 &  \\ 
  ERR4890294 & ERR4891889 & ERR5063807 & ERR5082576 & SRR13021011 &  \\ 
  ERR4890337 & ERR4891898 & ERR5063813 & ERR5082578 & SRR13021013 &  \\ 
  ERR4890352 & ERR4891988 & ERR5063922 & ERR5082580 & SRR13021017 &
\end{tabular}
\caption{\label{resampled_acc}Accession numbers for the resampling application.
The prefix ERR indicates that the sequence comes from the European Nucleotide Archive, whereas the prefix SRR indicates that it comes from the NCBI's Short Read Archive.}
\end{table}

% latex table generated in R 4.0.4 by xtable 1.8-4 package                                                                                                                             
% Wed Nov 24 11:09:36 2021
\begin{table}[ht]
\centering
\begin{tabular}{llllll}      
ERR4333012 & ERR4598849 & ERR4645575 & ERR4763502 & ERR4893972 & ERR5189526 \\ 
  ERR4422411 & ERR4599609 & ERR4647168 & ERR4763917 & ERR4905630 & ERR5196271 \\ 
  ERR4423341 & ERR4632053 & ERR4651160 & ERR4788047 & ERR4906265 & ERR5240413 \\ 
  ERR4423907 & ERR4633143 & ERR4652052 & ERR4792808 & ERR4989718 & ERR5277731 \\ 
  ERR4424340 & ERR4633439 & ERR4652877 & ERR4793403 & ERR5020396 & ERR5293387 \\ 
  ERR4424995 & ERR4633631 & ERR4659368 & ERR4824581 & ERR5021500 & ERR5304264 \\ 
  ERR4437121 & ERR4637060 & ERR4667806 & ERR4824816 & ERR5025790 & ERR5307708 \\ 
  ERR4437452 & ERR4639632 & ERR4668406 & ERR4824949 & ERR5027044 & ERR5314268 \\ 
  ERR4438147 & ERR4639682 & ERR4668440 & ERR4825023 & ERR5040813 & ERR5316846 \\ 
  ERR4438486 & ERR4639875 & ERR4668990 & ERR4826433 & ERR5041080 & ERR5334211 \\ 
  ERR4459703 & ERR4640333 & ERR4669218 & ERR4827255 & ERR5052912 & ERR5339018 \\ 
  ERR4459988 & ERR4640467 & ERR4686528 & ERR4835054 & ERR5052951 & ERR5339175 \\ 
  ERR4460366 & ERR4640673 & ERR4686632 & ERR4848811 & ERR5054027 & ERR5349715 \\ 
  ERR4463279 & ERR4641513 & ERR4686760 & ERR4849464 & ERR5057371 & ERR5353067 \\ 
  ERR4581201 & ERR4641559 & ERR4688435 & ERR4860936 & ERR5058153 & ERR5379217 \\ 
  ERR4584371 & ERR4642761 & ERR4688535 & ERR4861339 & ERR5177079 & SRR12349113 \\ 
  ERR4584814 & ERR4643065 & ERR4699831 & ERR4874605 & ERR5181042 & SRR12349131 \\ 
  ERR4597698 & ERR4643184 & ERR4706873 & ERR4874858 & ERR5187190 &  \\ 
  ERR4597906 & ERR4644945 & ERR4763252 & ERR4878261 & ERR5188799 &  \\ 
\end{tabular}
\caption{\label{rtt_acc}Accession numbers used in the root-to-tip application.
The prefix ERR indicates that the sequence comes from the European Nucleotide Archive, whereas the prefix SRR indicates that it comes from the NCBI's Short Read Archive.}
\end{table}

\end{document}