---
title: "Results of PangoVis"
author: "Devan Becker"
date: "`r Sys.Date()`"
output:
    pdf_document:
      citation_package: natbib
params:
    dirich: FALSE
---


# Load Packages and Data

```{r load}
# Packages that Art hates
library(dplyr)
library(tidyr)
library(ggplot2)
library(stringr)
library(here)

dirich <- TRUE #params$dirich

# Read in CSV files
csvs <- list.files(here("data/", "pangolineages"),
    pattern = ifelse(dirich, "*_d.csv", "*.csv"),
    full.names = TRUE)

# Remove any copies
csvs <- csvs[!grepl("-1", csvs)]

# Bring them into one data frame
lins <- bind_rows(lapply(csvs, read.csv))

# Taxon is encoded as _ACCSESSIONNUMBER.ID, split into ACCESSIONNUMBER and ID
lins <- lins %>%
    separate(col = "taxon", sep = "\\.",
        into = c("taxon", "sample")) %>%
    mutate(taxon = str_replace(taxon, "\\_", ""))

badlins <- table(lins$taxon)
badlins <- names(badlins[which(badlins < 1000)])
cat(length(badlins), " runs were removed for having too few samples.")
lins <- filter(lins, !taxon %in% badlins)

#### Visualize the uncertainty in the base calls ----
taxons <- unique(lins$taxon)
length(taxons)

```

# Abstract Info

```{r abstract}
summs <- lins %>%
    group_by(taxon) %>%
    summarise(
        maxperc = mean(lineage == names(sort(table(lineage),
            decreasing = TRUE)[1]),
        uniques = length(unique(lineage)),
        minpango = min(probability),
        maxpango = max(probability),
        menpango = mean(probability),
        max = names(sort(table(lineage), decreasing = TRUE))[1]))

print("summary info")
print(summs)
1 - mean(summs$maxperc); 1 - mean(summs$menpango)
```

# Stacked Bar Plots

```{r pareto, fig.height=10, fig.width=10}
max_label <- max(table(lins$taxon)) / 40

par(mfrow = c(15, 1), mar = c(1, 0.5, 1.5, 0.5))
for (i in 1:38) {
    pang <- lins[lins$taxon == taxons[i], ]
    called <- pang$lineage[pang$sample == 0][1]
    pangtab <- sort(table(pang$lineage), decreasing = TRUE)

    colvec <- rep("grey", length(pangtab))
    colvec[which(names(pangtab) == called)] <- "red"

    n <- sum(pangtab > max_label)
    if (n > 1) {
        barlabx <- c(0, cumsum(pangtab[1:(n - 1)])) +
            pangtab[1:n] / 2

        barplot(as.matrix(pangtab),
            col = colvec, hori = TRUE, axes = FALSE)
        text(barlabx, 0.7, names(pangtab)[1:n])
        mtext(side = 3, text = taxons[i], cex = 0.75, las = 1)
        pretty_labels <- seq(0, sum(pangtab),
                by = ifelse(sum(pangtab) < 2000, 100, 1000))
        mtext(side = 1,
            at = pretty_labels,
            text = pretty_labels,
            line = 0,
            cex = 0.75
        )
    } else {
        cat("Taxon", taxons[i], "had", length(pangtab),
            "unique calls, with largest accounting for",
            pangtab[1], "lineage calls, \n\t with second place",
            pangtab[2], ". First place was",
            ifelse(names(pangtab)[1] == called, "", "not"),
            "the conseq call.\n")
    }
}
```
